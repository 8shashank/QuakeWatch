<html>

<head>
  <title>Nepal Earthquake Watch</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <meta http-equiv=’cache-control’ content=’no-cache’>
  <meta http-equiv=’expires’ content=’0′>
  <meta http-equiv=’pragma’ content=’no-cache’>
</head>

<body>
<h1>Nepal Earthquake Watch</h1>
<h3 id="loading">Loading data</h3>
<p id="notice">This page will update automatically in 5 minutes.</p>
<div id="tableContainer">
  <table id="quake_table" class="table">
  <thead>
  <tr>
    <th>Magnitude</th>
    <th>City</th>
    <th>Time</th>
  </tr>
  </thead>
  <tbody>
  </tbody>
  </table>
</div>
<script>
  var quakes=[];
  var interval=5;   // in minutes
  var quake_table=document.getElementById('quake_table');
  var quake_tbody=quake_table.getElementsByTagName('tbody')[0];
  var head= document.getElementsByTagName('head')[0];
  
  var url="http://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&starttime=2015-04-25&orderby=time";
  var init_url=url+"&callback=initTable"
  var loading=document.getElementById('loading');
  var count=0;
  
  function addRow(quake_info){
    row=document.createElement('tr');
    addColumn(row,quake_info["mag"]);
    addColumn(row,quake_info["place"]);
    var time_since=timeSince(new Date(parseInt(quake_info["time"])))+"ago";
    addColumn(row,time_since);
    quake_tbody.appendChild(row);
  }
  
  function addColumn(row,data){
    col=document.createElement('td');
    col.innerText=data;
    row.appendChild(col);
  }
  
  function drawTable(){
    quake_tbody.innerHTML="";
    quakes.forEach(addRow);
  }

  function initTable(page){
    addQuakes(page);
    drawTable();
  }
  
  function addQuakes(init_quakes){
    var features=init_quakes["features"];
    for(var i=0;i<features.length;i++){
      var id=features[i]["id"];
      if (quakes.length>0 && id==quakes[quakes.length-1]["id"]){
        alert("New earthquake detected!");
        return;
      }
      var prop=features[i]["properties"];
      var place=prop["place"];
      var end_idx=place.indexOf(", Nepal");
      if (end_idx!=-1){
        begin_idx=place.indexOf(" of ")+4;
        place=place.substring(begin_idx,end_idx);
        quakes.push({id:id,mag:prop["mag"],place:place,time:prop["time"]});
      }
    }
    show();
  }
  
  function show(){
    quake_table.style.display="block";
    loading.style.display="none";
  }
  
  function hide(){
    quake_table.style.display="none";
    loading.innerText="Please wait, loading data..";
  }
  
  function getPage(url){
    count++;
    oldscript=document.getElementById('usgs_script');
    if (oldscript!==null){
      console.log("Old script detected. Deleting..");
      head.removeChild(oldscript);
    }
    var script=document.createElement('script');
    script.type = "text/javascript";
    script.src = init_url;
    script.id="usgs_script";
    head.appendChild(script);
  }

  //Time since code, courtesy of Sky Sanders
  function timeSince(date) {
      var seconds = Math.floor((new Date() - date) / 1000);

      var interval = Math.floor(seconds / 31536000);

      if (interval > 1) {
          return interval + " years";
      }
      interval = Math.floor(seconds / 2592000);
      if (interval > 1) {
          return interval + " months";
      }
      interval = Math.floor(seconds / 86400);
      if (interval > 1) {
          return interval + " days";
      }
      interval = Math.floor(seconds / 3600);
      if (interval > 1) {
          return interval + " hours";
      }
      interval = Math.floor(seconds / 60);
      if (interval > 1) {
          return interval + " minutes";
      }
      return Math.floor(seconds) + " seconds";
  }

  hide();
  
  //remove notice
  setTimeout(function(){
    notice=document.getElementById("notice");
    notice.style.visibility="hidden";
    },3000);
    
  getPage(init_url);
  
  setInterval(function(){
    console.log("Updated page");
    getPage(init_url)
    },interval*1000*60);  

</script>
</body>
</html>